{{ define "partials/job_run.html" }}

<!--

This template, and the script that appears below the HTML, is used
in both the "job run" UI and the "run workflow batch" UI.

We fill in this info via the JobSummary object that the back end
passes through in the Init Event (server-sent event). JavaScript
on the front end parses the JobSummary and inserts data into the
divs and spans below. See the IDs of the divs and spans to get
an idea of what goes into them.

-->


<div class="row mb-1" id="packageOpDiv" style="display:none">
  <div class="col text-right font-weight-bold">Package Name</div>
  <div class="col-10" id="packageName"></div>
</div>

<div class="row mb-1" id="bagItProfileDiv" style="display:none">
  <div class="col text-right font-weight-bold">BagIt Profile</div>
  <div class="col-10">
    <span id="bagItProfileName"></span> <br />
    <span id="bagItProfileDescription"></span>
  </div>
</div>

<div class="row mb-1" id="payloadSummaryDiv" style="display:none">
  <div class="col text-right font-weight-bold">Payload Summary</div>
  <div class="col-10">
    <span id="directoryCount"></span> Directories <br />
    <span id="fileCount"></span> Files <br />
    <span id="byteCountHuman"></span> (<span id="byteCountFormatted"></span> bytes)<br />
  </div>
</div>

<div class="row mb-1" id="sourceFilesDiv" style="display:none">
  <div class="col text-right font-weight-bold">Files to Package</div>
  <div class="col-10">
    <ul id="sourceFiles" class="flush-no-marker"></ul>
  </div>
</div>

<div class="row mb-1" id="validationFilesDiv" style="display:none">
  <div class="col text-right font-weight-bold">Bags to Validate</div>
  <div class="col-10">
    <ul id="pathsToValidate" class="flush-no-marker"></ul>
  </div>
</div>

<div class="row mb-1" id="outputPathDiv" style="display:none">
  <div class="col text-right font-weight-bold">Output Path</div>
  <div class="col-10">
    <div id="outputPathLink" data-url=""></div>
  </div>
</div>

<div class="row mb-1" id="uploadFilesDiv" style="display:none">
  <div class="col text-right font-weight-bold">Files to Upload</div>
  <div class="col-10">
    <ul id="uploadFiles" class="flush-no-marker"></ul>
  </div>
</div>

<div class="row mb-1" id="uploadOpsDiv" style="display:none">
  <div class="col text-right font-weight-bold">Upload To</div>
  <div class="col-10">
    <ul id="uploadTargets" class="flush-no-marker"></ul>
  </div>
</div>

<div class="row" id="jobIdContainer" style="display:none;">
  {{ template "partials/dart_process.html" .jobSummary }}
</div>




<script>

  // Page globals
  var batchLineNumber = 1
  var completedUploads = []
  var weAreRunningAWorkflowBatch = false
  var settings = {}
  var staleBagExists = {{ .staleBagExists }}

  // This will be empty for workflow batches, but on the job_run
  // page this lets us display the job details as soon as the
  // page loads. If we have jobSummaryJson, we'll also make a
  // call to showJobDetails() in the page load event at the
  // bottom of this file. See below.
  {{ if .jobSummaryJson }}
  settings = JSON.parse({{ .jobSummaryJson }});
  console.log(settings)
  {{ end }}

  // runJob runs the job or workflow that the user requested,
  // initializing UI elements as necessary.
  function runJob(eventSourceUrl, jobId) {
    if (staleBagExists && !confirmDeletionOfStaleBag()) {
      console.log("User cancelled replacing/rebuilding existing bag.")
      return
    }
    clearMessageDivs()
    disableRunButtons()
    if (jobId && !eventSourceUrl.endsWith("/")) {
      eventSourceUrl += "/"
    }
    if (eventSourceUrl.includes("/workflows")) {
      initWorkflowUI()
    }
    // Attach event listeners to respond to job status updates
    // coming from the backend server.
    attachEventSourceListeners(eventSourceUrl, jobId)
  }

  function confirmDeletionOfStaleBag() {
    return confirm("An older version of this bag exists in the bagging directory. Click OK if you want to rebuild and replace the existing version.")
  }

  // This initializes the UI for running workflows, showing,
  // hiding, and clearing UI elements as necessary.
  function initWorkflowUI() {
    weAreRunningAWorkflowBatch = true
    // User may be re-running batch; remove previous result messages.
    $('#batchCompleted').hide();
    $('#workflowResults').remove('div.batch-result')
    $('#batchRunning').show();
    $('#workflowResults').show();
    $('div.batch-result').remove();
    batchLineNumber = 1
  }

  // Attach listeners to handle server-sent events (SSE).
  // These listeners receive messages from the server describing
  // the progress and outcome of running jobs, updating display
  // elements such as progress bars and message divs as the
  // job proceeds or completes.
  function attachEventSourceListeners(eventSourceUrl, jobId) {
    let eventSrc = new EventSource(eventSourceUrl + jobId)
    eventSrc.onmessage = (event) => {
      //console.log(event)
      if (!event.data) {
        console.log("Malformed message")
        console.log(event)
        return
      }
      var data
      try {
        data = JSON.parse(event.data)
      } catch (ex) {
        console.log(ex)
        console.log(event)
        return
      }

      switch (data.eventType) {
        case "init":
          showJobInit(data);
          break;
        case "batch completed":
          showBatchCompleted(data);
          break;
        case "disconnect":
          handleSSEDisconnect(data, eventSrc);
          break;
        case "warning":
          renderWarning(data);
          break;
        default:
          // This handles the default case, where eventType == "info".
          // Most messages have this type.
          renderInfo(data);
      }
    }
    eventSrc.onerror = (event) => {
      console.error(event)
    }
  }

  // This displays the basic info about the job, including
  // what, if anything, should be packaged, validated and/or uploaded.
  // This is called when a job is loaded.
  function showJobInit(data) {
    $("#spinner").hide()
    console.log(`Received init event for job ${data.jobSummary.id}`)
    settings = data.jobSummary
    console.log(settings)
    showJobDetails()
    showProgressDivs()
    clearMessageDivs()
  }

  // This displays information about the status of a batch job
  // after all jobs in the batch have been run. This is triggered
  // when the server sends the "batch completed" event.
  function showBatchCompleted(data) {
    console.log("Received batch completed event")
    $('#batchRunning').hide();
    $('#batchCompleted').show();
    $('#runWorkflowBatch').prop('disabled', false)
  }

  // This disconnects the page from server-sent events.
  // It's called when we receive the disconnect event
  // from the server. If you fail to call this, the UI
  // will keep re-running the job forever.
  function handleSSEDisconnect(data, eventSrc) {
    console.log("Received disconnect from server")
    console.log(data.message)
    eventSrc.close()
  }

  // Disable run buttons so user can't kick off a job
  // while the job is already running.
  function disableRunButtons() {
    $('#btnRunJob').prop('disabled', true)
    $('#runWorkflowBatch').prop('disabled', true)
  }

  // This displays the initial details of a job, including
  // what is to be packaged, validated, and/or uploaded.
  function showJobDetails() {
    $('#jobName').html(settings.Name)
    clearAndHidePackagingInfo()
    if (settings.hasPackageOp) {
      showPackagingInfo()
    }
    if (settings.jobType == "ValidationJob") {
      showValidationJobInfo()
    }
    if (settings.hasUploadOps) {
      showUploadOps()
    } else {
      clearAndHideUploadInfo()
    }
  }

  // Clear the packaging info from the UI and hide the
  // div elements that display that info. This part of
  // the UI reset called as each new job starts.
  function clearAndHidePackagingInfo() {
    $('#packageOpDiv').hide()
    $('#bagItProfileDiv').hide()
    $('#payloadSummaryDiv').hide()
    $('#sourceFilesDiv').hide()
    $('#outputPathDiv').hide()

    $('#packageName').empty()
    $('#bagItProfileName').empty()
    $('#bagItProfileDescription').empty()
    $('#directoryCount').empty()
    $('#fileCount').empty()
    $('#byteCountHuman').empty()
    $('#byteCountFormatted').empty()
    $('#outputPathLink').empty()
    $('#sourceFiles').empty()
  }

  // Display info about what is to be packaged.
  // This uses the page global settings variable.
  function showPackagingInfo() {
    $('#packageName').html(settings.packageName)
    $('#bagItProfileName').html(settings.bagItProfileName)
    $('#bagItProfileDescription').html(settings.bagItProfileDescription)
    $('#directoryCount').html(settings.directoryCount)
    $('#fileCount').html(settings.payloadFileCount)
    $('#byteCountHuman').html(settings.byteCountHuman)
    $('#byteCountFormatted').html(settings.byteCountFormatted)
    $('#outputPathLink').html(settings.outputPath)

    for (let item of settings.sourceFiles) {
      $('#sourceFiles').append(`<li>${item}</li>`)
    }

    $('#packageOpDiv').show()
    $('#bagItProfileDiv').show()
    $('#payloadSummaryDiv').show()
    $('#sourceFilesDiv').show()
    $('#outputPathDiv').show()
  }

  // Remove info about uploads from UI. We call
  // this when running a job that has no upload
  // operations.
  function clearAndHideUploadInfo() {
    $('#uploadOpsDiv').hide()
    $('#uploadFilesDiv').hide()
    $('#uploadTargets').empty()
    $('#uploadFilesDiv').empty()
  }

  // Display information about a job's upload operations
  // in the UI.
  function showUploadOps() {
    $('#uploadOpsDiv').show()
    $('#uploadTargets').empty()
    for (let item of settings.uploadTargets) {
      $('#uploadTargets').append(`<li>${item}</li>`)
    }
    // If this is an upload-only job, display the
    // list of files to be uploaded.
    if (settings.jobType == "UploadJob") {
      $('#uploadFiles').empty()
      $('#uploadFilesDiv').show()
      for (let item of settings.sourceFiles) {
        $('#uploadFiles').append(`<li>${item}</li>`)
      }
    }
  }

  // This is specific to validation-only jobs.
  function showValidationJobInfo() {
    console.log("Adding paths to validation job info div")
    $('#pathsToValidate').empty()
    $('#bagItProfileName').text(settings.bagItProfileName)
    $('#bagItProfileDescription').text(settings.bagItProfileDescription)
    $('#bagItProfileDiv').show()
    var sourceListElement = $('#pathsToValidate')
    settings.sourceFiles.forEach(function (path) {
      sourceListElement.append(`<li>${path}</li>`)
    })
    $('#validationFilesDiv').show()
  }

  // Hide details of a validation-only job.
  function hideValidationJobInfo() {
    $('#validationFilesDiv').hide()
  }

  // Display progress divs, which contain the progress bars
  // for different parts of the job. Note that the logic
  // uses the page global settings object to determine which
  // operations are part of the job, and hence which progress
  // bars should be displayed.
  function showProgressDivs() {
    let processDiv = $('#jobIdContainer');
    if (settings.hasPackageOp) {
      initProgressBar('packageInfo');
      $(`#runningJobDisplay div.packageInfo`).show();
      if (settings.packageFormat == 'BagIt') {
        initProgressBar('validationInfo');
        $(`#runningJobDisplay div.validationInfo`).show();
      }
    }
    if (settings.jobType == "ValidationJob") {
      initProgressBar('validationInfo');
      $(`#runningJobDisplay div.validationInfo`).show();
    }
    if (settings.hasUploadOps) {
      initProgressBar('uploadInfo');
      $(`#runningJobDisplay div.uploadInfo`).show();
    }
    $(`#job-start-time`).text(new Date().toLocaleString());
    processDiv.show();
  }

  // This clears the contents of all the job-related message divs.
  // We call this before running a new job.
  function clearMessageDivs() {
    let sections = ["packageInfo", "validationInfo", "uploadInfo", "outcomeInfo"]
    sections.forEach(function (section) {
      var [detailDiv, progressBar] = getDivs(section)
      detailDiv.html("")
      let warningDiv = detailDiv.siblings("div.text-warning").first()
      warningDiv.html("")
    })
    // Clear the outcome info as well, or error messages from
    // prior run may continue to display.
    let outcomeMessageDiv = $("#runningJobDisplay div.outcomeInfo div.detail div.message");
    outcomeMessageDiv.html("");
  }

  // Display a warning message in the info div of one section
  // of the UI. There is one section for each job stage:
  // packaging, validation, and upload, plus one for the
  // overall job outcome.
  function renderWarning(data) {
    let section = data.stage + "Info"
    var [detailDiv, progressBar] = getDivs(section)
    let warningDiv = detailDiv.siblings("div.text-warning").first()
    warningDiv.html("Warning: " + data.message)
    warningDiv.removeClass("d-none")
    warningDiv.show()
  }

  // Renders info contained in the data sent by a server-side
  // event. This is info about the progress or status of the
  // currently running job.
  function renderInfo(data) {
    let section = data.stage + "Info"
    var [detailDiv, progressBar] = getDivs(section);
    // A job can include multiple uploads. For each new
    // upload, we want to set the progress bar back to
    // zero and render it in blue.
    if (data.eventType == "start") {
      initProgressBar('uploadInfo')
    }
    if (data.eventType == "finish") {
      renderFinishInfo(section, data, detailDiv, progressBar)
    } else { // start or info message
      detailDiv.text(data.message)
      setProgressBar(progressBar, data);
    }
    // If we're running a workflow batch, we need to reset
    // this for the next job.
    if (weAreRunningAWorkflowBatch) {
      completedUploads = []
    }
  }

  // Renders info to the UI about the status and outcome
  // of a finished job.
  function renderFinishInfo(section, data, detailDiv, progressBar) {
    console.log(data)
    if (data.status == "success") {
      if (section == "") {
        completedUploads.push(data.message)
        markSuccess(detailDiv, progressBar, completedUploads.join("<br/>\n"))
      } else {
        markSuccess(detailDiv, progressBar, data.message)
      }
      activateOutputPathLink()
      showBatchJobSucceeded(data)
    } else if (data.status == "failed") {
      // Finish with error. Note that detail div here is the outcome
      // div, not the div for the current stage, because job has finished.
      detailDiv = $(`#runningJobDisplay div.outcomeInfo div.detail div.message`);
      markFailed(detailDiv, progressBar, getErrorsAsHTML(data))
      showBatchJobFailed(data)
    }
    if (data.stage = "") {
      // We just completed a job, not a stage.
      batchLineNumber += 1
    }
    if (!weAreRunningAWorkflowBatch) {
      // This is not a batch. We just completed a job.
      // So now it's safe to reactivate the Run Job button.
      $('#btnRunJob').prop('disabled', false)
    }
  }

  // Returns the divs containing the progress bar and message area
  // for the specified section/job operation. Valid sections are:
  // "package", "validation", "upload" and "outcome".
  function getDivs(section) {
    let selectorPrefix = `#runningJobDisplay div.${section} div.detail`;
    let detailDiv = $(`${selectorPrefix} div.message`);
    let progressBar = $(`${selectorPrefix} div.progress-bar`);
    return [detailDiv, progressBar];
  }

  // Initializes the progress bar for the specified section.
  function initProgressBar(section) {
    let [_, progressBar] = getDivs(section);
    if (progressBar) {
      progressBar.removeClass("bg-success");
      progressBar.removeClass("bg-danger");
      let initialClasses = ["progress-bar-striped", "progress-bar-animated"];
      for (let cssClass of initialClasses) {
        if (progressBar.hasClass(cssClass)) {
          progressBar.addClass(cssClass);
        }
      }
      data = { percent: 0 }
      setProgressBar(progressBar, data)
    }
  }

  // Sets the width of the specified progress bar based on data.percent.
  function setProgressBar(progressBar, data) {
    // Sometimes the data object does not include percentComplete,
    // and when percentComplete is unknown, it's set to -1.
    if (isNaN(data.percent) || data.percent < 0) {
      return;
    }
    // In bag creation, progress bar hits 100% when all payload
    // files are added. We have to add tag files and manifests
    // afterward, and we don't want the bar to bounce, so no
    // changes after it reaches 100%.
    //
    // Similarly with validation, the bar hits 100% when all checksums
    // have been verified, but the validator still has a few remaining
    // tasks, including tag file validation.
    //
    // In both cases, the bar will stick at 100% for a second or two.
    // When all items are complete, the bar animation will stop and
    // the bar will turn green.

    // console.log(progressBar)
    console.log(data)

    if (parseInt(progressBar.attr("aria-valuenow"), 10) != 100) {
      progressBar.attr("aria-valuenow", data.percent);
      progressBar.css("width", data.percent + '%');
    }
  }

  // Displays info showing that a stage of the job has succeeded
  // by doing the following:
  //
  // 1. Sets the progress bar to green and progress amount to 100%.
  // 2. Displays message in detailDiv.
  //
  // Params:
  //
  // detailDiv - jQuery HTMLElement - The div in which to display
  // the message.
  //
  // progressBar - jQuery HTMLElement - The progress bar to be set
  // to 100% / green.
  //
  // message - string - The message to display in detailDiv.
  //
  function markSuccess(detailDiv, progressBar, message) {
    detailDiv.html(message);
    if (progressBar) {
      setProgressBar(progressBar, { percent: 100 });
      progressBar.removeClass("progress-bar-striped progress-bar-animated");
      progressBar.addClass("bg-success");
    }
  }

  // Displays info showing that a stage of the job has failed
  // by doing the following:
  //
  // 1. Sets the progress bar to red and progress amount to 100%.
  // 2. Displays message in detailDiv.
  //
  // Params:
  //
  // detailDiv - jQuery HTMLElement - The div in which to display
  // the message.
  //
  // progressBar - jQuery HTMLElement - The progress bar to be set
  // to 100% / red.
  //
  // message - string - The message to display in detailDiv.
  //
  function markFailed(detailDiv, progressBar, message) {
    detailDiv.html(message);
    if (progressBar) {
      progressBar.removeClass("progress-bar-striped progress-bar-animated");
      progressBar.attr("aria-valuenow", 100);
      progressBar.css("width", '100%');
      progressBar.addClass("bg-danger");
    }
  }

  // Reads the errors in data.jobResult and returns a formatted
  // HTML string suitable for display in the UI.
  function getErrorsAsHTML(data) {
    var result = data.jobResult
    if (!result) {
      return "<p>Cannot get error details from job result.</p>"
    }

    // Start the HTML with any packaging errors that may have occurred.
    var html = ""
    if (result.packageResult && result.packageResult.errors && Object.values(result.packageResult.errors).length > 0) {
      html += "<p class='font-weight-bold'>Packaging Errors</p><ol>"
      Object.values(result.packageResult.errors).forEach(function (errMessage) {
        html += `<li>${errMessage}</li>`
      })
      html += "</ol>"
    }

    // Now add bag validation errors if there were any.
    if (result.validationResults) {
      result.validationResults.forEach(function (validationResult) {
        if (validationResult.errors && Object.values(validationResult.errors).length > 0) {
          if (validationResult.info) {
            // This is a validation-only job, which can have multiple validation results.
            // In this case, the bag path is in the info.
            html += `<p class='font-weight-bold'>Validation Errors for ${validationResult.info}</p><ol>`
          } else {
            // This is a standard package, validate & upload job.
            html += `<p class='font-weight-bold'>Validation Errors</p><ol>`
          }
          Object.values(validationResult.errors).forEach(function (errMessage) {
            html += `<li>${errMessage}</li>`
          })
          html += "</ol>"
        }
      })
    }

    // Now add upload errors if there were any.
    if (result.uploadResults) {
      let greenCheck = '<i class="fa fa-check mr-2" aria-hidden="true" style="color: green;"></i>'
      let redX = '<i class="fa fa-times mr-2" aria-hidden="true" style="color: red;"></i>'
      result.uploadResults.forEach(function (uploadResult) {
        if (uploadResult.errors && Object.values(uploadResult.errors).length > 0) {
          html += `<p class='font-weight-bold'>${redX} Upload Errors (${uploadResult.remoteTargetName})</p><ol>`
          Object.values(uploadResult.errors).forEach(function (errMessage) {
            html += `<li>${errMessage}</li>`
          })
          html += "</ol>"
        } else {
          html += `<p class='font-weight-bold'>${greenCheck} Upload Succeeded - (${uploadResult.remoteTargetName})</p>`
        }
      })
    }

    // Et voila!
    return html
  }

  // When a job starts, the UI displays the path to the output
  // file (the result of the packaging operation, which is usually
  // a bag). The bag won't be there until the packaging operation
  // succeeds. When it does, this function converts the plain-text
  // file path to a clickable link, so the user can click to see
  // the package/bag in their file browser.
  function activateOutputPathLink() {
    var div = $('#outputPathLink')
    var url = settings.outputPath
    var dir = url.split(settings.pathSeparator).slice(0, -1).join(settings.pathSeparator)
    var html = `<a href="javascript:openExternalUrl('${dir}')">${url}</a>`
    div.html(html)
  }


  // Display a message saying that one job in a batch (which
  // maps to one line in a batch file) has succeeded.
  function showBatchJobSucceeded(data) {
    if (weAreRunningAWorkflowBatch && data.stage == "") {
      let html = `<div class="row batch-result">
            <i class="fa fa-check mr-2" aria-hidden="true" style="color: green;"></i>
            Line ${batchLineNumber} - ${settings.name}
            </div>`
      $('#workflowResults').append(html)
      batchLineNumber += 1
    }
  }

  // Display a message saying that one job in a batch (which
  // maps to one line in a batch file) has failed.
  function showBatchJobFailed(data) {
    if (weAreRunningAWorkflowBatch && data.stage == "" && data.jobResult) {
      let errors = getAllErrorsFromJobResult(data.jobResult)
      let errItems = []
      for (const err of errors) {
        if (err.endsWith(' succeeded')) {
          errItems.push(`<li class="text-success">${err}</li>`)
        } else {
          errItems.push(`<li class="text-danger">${err}</li>`)
        }
      }
      let html = `
          <div class="row batch-result">
            <i class="fa fa-times mr-2" aria-hidden="true" style="color: red;"></i>
              Line ${batchLineNumber} - ${settings.name}
            <ul>
              ${errItems.join("\n")}
            </ul>
          </div>`
      $('#workflowResults').append(html)
      batchLineNumber += 1
    }
  }

  // Given a JobResult object, this collects all of the errors
  // and returns them as an array of strings.
  function getAllErrorsFromJobResult(result) {
    let errors = []
    errors = errors.concat(getErrorsFromOperation(result.packageResult))
    if (result.validationResults) {
      for (const validationResult of result.validationResults) {
        errors = errors.concat(getErrorsFromOperation(validationResult))
      }
    }
    if (result.uploadResults) {
      for (const uploadResult of result.uploadResults) {
        errors = errors.concat(getErrorsFromOperation(uploadResult))
      }
    }
    return errors
  }

  // Returns a list of errors from the specified operation result.
  function getErrorsFromOperation(opResult) {
    let errors = []
    if (opResult && opResult.errors) {
      Object.keys(opResult.errors).sort().forEach(function (key, i) {
        errors.push(`${key}: ${opResult.errors[key]}`)
      })
    }
    if (errors.length == 0) {
      var message = ucfirst(opResult.operation + " succeeded")
      if (opResult.remoteTargetName != "") {
        message = `Upload to ${opResult.remoteTargetName} succeeded`
      }
      errors.push(message)
    }
    return errors
  }

  // Converts the first letter of a string to upper case.
  function ucfirst(s) {
    return s[0].toUpperCase() + s.slice(1);
  }

  // If we have jobSummaryJson on load, then show the job details.
  $(function () {
    {{ if .jobSummaryJson }}
    showJobDetails()
    {{ end }}
  })
</script>

{{ end }}